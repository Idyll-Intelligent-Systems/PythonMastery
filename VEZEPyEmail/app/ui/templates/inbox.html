{% extends "base.html" %}
{% block content %}
<div class="app">
  <div class="topbar">
    <div class="brand">✉️ VEZEPyEmail</div>
    <div class="search">
      <form method="get" action="/ui/inbox">
        <input name="q" value="{{ request.query_params.get('q') or '' }}" placeholder="Search mail" />
        <button class="btn secondary" type="submit">Search</button>
      </form>
    </div>
    <div class="actions">
      <button class="btn secondary">Refresh</button>
      <button class="btn">Compose</button>
    </div>
  </div>
  <div class="layout">
    <aside class="sidebar">
      <div class="compose"><button class="btn">+ Compose</button></div>
      <nav class="folders">
        <a class="folder active" href="#">Inbox</a>
        <a class="folder" href="#">Starred</a>
        <a class="folder" href="#">Sent</a>
        <a class="folder" href="#">Drafts</a>
        <a class="folder" href="#">Spam</a>
        <a class="folder" href="#">Trash</a>
      </nav>
    </aside>
    <section class="list">
      {% set messages = messages or [] %}
      {% for m in messages %}
        {% set _ = m.update({'from': m.get('from') or m.get('from_')}) %}
        {% include "_message_row.html" %}
      {% endfor %}
      {% if not messages %}
      <div class="thread">
        <div class="meta">Your inbox is empty</div>
      </div>
      {% endif %}
    </section>
    <section class="detail">
      <div class="msg-head"><div>Preview</div><div class="msg-tools"><button class="btn secondary">Archive</button><button class="btn secondary">Delete</button></div></div>
      <div class="msg-body">Select a message to read.</div>
    </section>
  </div>
  <div style="display:flex;gap:8px;justify-content:flex-end;padding:8px 16px;">
    {% set prev_offset = (request.query_params.get('offset')|int(default=0)) - 50 %}
    {% set next_offset = (request.query_params.get('offset')|int(default=0)) + 50 %}
    {% set q = request.query_params.get('q') %}
    {% if prev_offset >= 0 %}
    <a class="btn secondary" href="/ui/inbox?offset={{prev_offset}}{{'&q=' + q if q else ''}}">Prev</a>
    {% endif %}
    <a class="btn secondary" href="/ui/inbox?offset={{next_offset}}{{'&q=' + q if q else ''}}">Next</a>
  </div>
</div>
<script>
  (function(){
    function on(selector, evt, handler){ (document.querySelectorAll(selector)||[]).forEach(el=> el.addEventListener(evt, handler)); }
    async function post(url, body){
      const res = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: body?JSON.stringify(body):null});
      if(!res.ok) throw new Error(await res.text());
      return res.json();
    }
    on('.star-btn','click', async (e)=>{
      e.preventDefault(); e.stopPropagation();
      const id = e.currentTarget.dataset.id;
      // If htmx is available, let it swap the row via partial
      if (window.htmx) {
        const row = e.currentTarget.closest('.thread');
        if(row){
          try{
            await fetch(`/api/messages/${id}/star?access_token=demo`, {method:'POST'});
            const res = await fetch(`/api/messages/${id}/row?access_token=demo`);
            row.outerHTML = await res.text();
            return;
          }catch(err){ console.error(err); }
        }
      }
      try{
        const data = await post(`/api/messages/${id}/star?access_token=demo`);
        e.currentTarget.textContent = data.starred ? '★' : '☆';
      }catch(err){ console.error(err); }
    });
    on('.label-btn','click', async (e)=>{
      e.preventDefault(); e.stopPropagation();
      const id = e.currentTarget.dataset.id;
      const labels = prompt('Set labels (comma separated):','Important,Work');
      if(labels===null) return;
      const arr = labels.split(',').map(s=>s.trim()).filter(Boolean);
      if (window.htmx) {
        const row = e.currentTarget.closest('.thread');
        if(row){
          try{
            await post(`/api/messages/${id}/labels?access_token=demo`, {labels: arr});
            const res = await fetch(`/api/messages/${id}/row?access_token=demo`);
            row.outerHTML = await res.text();
            return;
          }catch(err){ console.error(err); }
        }
      }
      try{
        await post(`/api/messages/${id}/labels?access_token=demo`, {labels: arr});
        // naive refresh
        location.reload();
      }catch(err){ console.error(err); }
    });
  })();
</script>
{% endblock %}
