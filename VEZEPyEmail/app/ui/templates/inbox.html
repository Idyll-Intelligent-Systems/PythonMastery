{% extends "base.html" %}
{% block content %}
<div class="app">
  <div class="topbar">
    <div class="brand">✉️ VEZEPyEmail</div>
    <div class="search">
      <form method="get" action="/ui/inbox">
        <input name="q" value="{{ request.query_params.get('q') or '' }}" placeholder="Search mail" />
        <button class="btn secondary" type="submit">Search</button>
      </form>
    </div>
    <div class="actions">
      <a class="btn secondary" href="/ui/inbox">Refresh</a>
      <a class="btn" href="/ui/compose">Compose</a>
    </div>
  </div>
  <div class="layout">
    <aside class="sidebar">
  <div class="compose"><a class="btn" href="/ui/compose">+ Compose</a></div>
      <nav class="folders">
        <a class="folder active" href="#">Inbox</a>
        <a class="folder" href="#">Starred</a>
        <a class="folder" href="#">Sent</a>
        <a class="folder" href="#">Drafts</a>
        <a class="folder" href="#">Spam</a>
        <a class="folder" href="#">Trash</a>
      </nav>
    </aside>
    <section class="list">
      {% set messages = messages or [] %}
      {% for m in messages %}
        {% set _ = m.update({'from': m.get('from') or m.get('from_')}) %}
        {% include "_message_row.html" %}
      {% endfor %}
      {% if not messages %}
      <div class="thread">
        <div class="meta">Your inbox is empty</div>
      </div>
      {% endif %}
    </section>
    <section class="detail">
      <div class="msg-head"><div id="preview-title">Preview</div><div class="msg-tools"><button id="btn-expand" class="btn secondary" title="Open full">Expand</button><button id="btn-min" class="btn secondary" title="Minimize">Minimize</button></div></div>
      <div class="msg-body" id="preview-body">Select a message to read.</div>
    </section>
  </div>
  <div style="display:flex;gap:8px;justify-content:flex-end;padding:8px 16px;">
    {% set prev_offset = (request.query_params.get('offset')|int(default=0)) - 50 %}
    {% set next_offset = (request.query_params.get('offset')|int(default=0)) + 50 %}
    {% set q = request.query_params.get('q') %}
    {% if prev_offset >= 0 %}
    <a class="btn secondary" href="/ui/inbox?offset={{prev_offset}}{{'&q=' + q if q else ''}}">Prev</a>
    {% endif %}
    <a class="btn secondary" href="/ui/inbox?offset={{next_offset}}{{'&q=' + q if q else ''}}">Next</a>
  </div>
</div>
<script>
  (function(){
    function on(selector, evt, handler){ (document.querySelectorAll(selector)||[]).forEach(el=> el.addEventListener(evt, handler)); }
    // Inline preview: clicking a row shows it on the right; Expand opens full page
    const detailTitle = document.getElementById('preview-title');
    const detailBody = document.getElementById('preview-body');
    let currentMsgId = null;
    document.querySelectorAll('.thread').forEach(a=>{
      a.addEventListener('click', async (e)=>{
        e.preventDefault();
        const id = e.currentTarget.getAttribute('data-id');
        currentMsgId = id;
        try{
          const res = await fetch(`/api/messages/${id}/row?access_token=demo`);
          if(res.ok){
            const html = await res.text();
            // Parse title/snippet from the snippet markup
            const tmp = document.createElement('div'); tmp.innerHTML = html;
            const subj = (tmp.querySelector('.subj')?.childNodes[0]?.textContent || '').trim();
            const snippet = (tmp.querySelector('.snippet')?.textContent || '').trim();
            if(detailTitle) detailTitle.textContent = subj || `Message #${id}`;
            if(detailBody) detailBody.textContent = snippet || '';
          } else {
            if(detailTitle) detailTitle.textContent = `Message #${id}`;
            if(detailBody) detailBody.textContent = 'Unable to load preview.';
          }
        }catch(_){ if(detailBody) detailBody.textContent = 'Error loading preview.'; }
      });
    });
    const btnExpand = document.getElementById('btn-expand');
    if(btnExpand){ btnExpand.addEventListener('click', ()=>{ if(currentMsgId) window.location.href = `/ui/message/${currentMsgId}`; }); }
    const btnMin = document.getElementById('btn-min');
    if(btnMin){ btnMin.addEventListener('click', ()=>{ currentMsgId=null; if(detailTitle) detailTitle.textContent='Preview'; if(detailBody) detailBody.textContent='Select a message to read.'; }); }
    async function post(url, body){
      const res = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: body?JSON.stringify(body):null});
      if(!res.ok) throw new Error(await res.text());
      return res.json();
    }
    on('.star-btn','click', async (e)=>{
      e.preventDefault(); e.stopPropagation();
      const id = e.currentTarget.dataset.id;
      // If htmx is available, let it swap the row via partial
      if (window.htmx) {
        const row = e.currentTarget.closest('.thread');
        if(row){
          try{
            await fetch(`/api/messages/${id}/star?access_token=demo`, {method:'POST'});
            const res = await fetch(`/api/messages/${id}/row?access_token=demo`);
            row.outerHTML = await res.text();
            return;
          }catch(err){ console.error(err); }
        }
      }
      try{
        const data = await post(`/api/messages/${id}/star?access_token=demo`);
        e.currentTarget.textContent = data.starred ? '★' : '☆';
      }catch(err){ console.error(err); }
    });
    on('.label-btn','click', async (e)=>{
      e.preventDefault(); e.stopPropagation();
      const id = e.currentTarget.dataset.id;
      const labels = prompt('Set labels (comma separated):','Important,Work');
      if(labels===null) return;
      const arr = labels.split(',').map(s=>s.trim()).filter(Boolean);
      if (window.htmx) {
        const row = e.currentTarget.closest('.thread');
        if(row){
          try{
            await post(`/api/messages/${id}/labels?access_token=demo`, {labels: arr});
            const res = await fetch(`/api/messages/${id}/row?access_token=demo`);
            row.outerHTML = await res.text();
            return;
          }catch(err){ console.error(err); }
        }
      }
      try{
        await post(`/api/messages/${id}/labels?access_token=demo`, {labels: arr});
        // naive refresh
        location.reload();
      }catch(err){ console.error(err); }
    });
  })();
</script>
{% endblock %}
